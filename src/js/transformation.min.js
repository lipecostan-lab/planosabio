var dataSourceMappings, testdata;

function initializeMappings() {
    var e = (document.cookie.split("; ").filter((function(e) {
            return 0 === e.indexOf("variationTN=")
        }))[0] || "").split("=")[1] || null,
        a = (e = null === e ? null : e + "_" + ((document.cookie.split("; ").filter((function(e) {
            return 0 === e.indexOf("variation=")
        }))[0] || "").split("=")[1] || null), "affiliate");
    dataSourceMappings = {
        buygoods: {
            slotCount: 1,
            parameterMap: {
                vid1: {
                    params: ["ws_source", "ws_medium", "ws_campaign", "ws_content", "ws_term"],
                    defaults: [a, window.productName, encodeURI(window.location.hostname + window.location.pathname), window.leadID, e]
                }
            }
        },
        clickbank: {
            parameterMap: {
                utm_source: {
                    param: "ws_source",
                    default: a
                },
                utm_medium: {
                    param: "ws_medium",
                    default: window.productName
                },
                utm_campaign: {
                    param: "ws_campaign",
                    default: encodeURI(window.location.hostname + window.location.pathname)
                },
                utm_content: {
                    param: "ws_content",
                    default: window.leadID
                },
                utm_term: {
                    param: "ws_term",
                    default: e
                }
            }
        },
        digistore: {
            slotCount: 1,
            parameterMap: {
                ds24tr: {
                    params: ["ws_source", "ws_medium", "ws_campaign", "ws_content", "ws_term"],
                    defaults: [a, window.productName, encodeURI(window.location.hostname + window.location.pathname), window.leadID, e]
                }
            }
        },
        everflow: {
            slotCount: 1,
            parameterMap: {
                ds24tr: {
                    params: ["ws_source", "ws_medium", "ws_campaign", "ws_content", "ws_term"],
                    defaults: [a, window.productName, encodeURI(window.location.hostname + window.location.pathname), window.leadID, e]
                }
            }
        }
    }
}

function getParameterMap(e) {
    var a = dataSourceMappings[e];
    return a ? a.parameterMap : (console.error("No mapping found for data source: " + e), null)
}

function getTrafficSourceValues() {
    for (var e, a, t = window.location.search.substring(1), o = t ? t.split("&") : [], r = {}, n = 0; n < o.length; n++) a = o[n].split("="), e = decodeURIComponent(a[0]), a = decodeURIComponent(a[1] || ""), r[e] = a;
    return r
}

function createValueMap(e, a) {
    var t, o, r, n = {},
        i = !1;
    for (t in e)
        if (Object.prototype.hasOwnProperty.call(e, t))
            if ((o = e[t]).params && Array.isArray(o.params)) {
                for (var s = [], p = 0; p < o.params.length; p++) {
                    var u = a[o.params[p]] || "";
                    u ? (i = !0, s.push(u)) : s.push("")
                }
                s.some(Boolean) || (s = o.defaults), n[t] = s.join("||")
            } else o.param && (r = o.param, o.default, (r = a[r]) && (i = !0), n[t] = r || "");
    if (!i)
        for (t in e) Object.prototype.hasOwnProperty.call(e, t) && (o = e[t], n[t] = Array.isArray(o.defaults) ? o.defaults.join("||") : o.default || "");
    return n
}

function parseQueryString(e) {
    for (var a, t, o = {}, r = e ? e.split("&") : [], n = 0; n < r.length; n++) t = r[n].split("="), a = decodeURIComponent(t[0]), t = decodeURIComponent(t[1] || ""), o[a] = t;
    return o
}

function buildQueryString(e) {
    var a, t, o = [];
    for (a in e) Object.prototype.hasOwnProperty.call(e, a) && (t = e[a], o.push(a + "=" + t));
    return o.join("&")
}

function updateLinks(i) {
    var e; - 1 !== window.location.pathname.indexOf("/int/") || -1 !== window.location.pathname.indexOf("/promo/") || -1 !== window.location.pathname.indexOf("/video/") ? updateWindowVariables(i) : (e = document.querySelectorAll("a[href], button[href], form[action]"), Array.prototype.forEach.call(e, (function(e) {
        var a = "";
        if ("a" === e.tagName.toLowerCase() || "button" === e.tagName.toLowerCase()) a = "href";
        else {
            if ("form" !== e.tagName.toLowerCase()) return;
            a = "action"
        }
        var t = e.getAttribute(a);
        if (t && 0 !== t.indexOf("javascript:") && 0 !== t.indexOf("mailto:") && 0 !== t.indexOf("#")) {
            var o, r = document.createElement("a"),
                n = (r.href = t, parseQueryString(r.search.substring(1)));
            for (o in i) Object.prototype.hasOwnProperty.call(i, o) && (n[o] = i[o]);
            t = buildQueryString(n);
            r.search = "?" + t, e.setAttribute(a, r.href)
        }
    })))
}

function updateWindowVariables(e) {
    var a, t = ["oneBottle", "threeBottle", "sixBottle"];
    for (a in window)
        if (Object.prototype.hasOwnProperty.call(window, a)) {
            for (var o = !1, r = 0; r < t.length; r++)
                if (0 === a.indexOf(t[r])) {
                    o = !0;
                    break
                }
            if (o) {
                var n = window[a];
                if ("string" == typeof n && /^https?:\/\//.test(n)) {
                    var i, s = document.createElement("a"),
                        p = (s.href = n, parseQueryString(s.search.substring(1)));
                    for (i in e) Object.prototype.hasOwnProperty.call(e, i) && (p[i] = e[i]);
                    n = buildQueryString(p);
                    s.search = "?" + n, window[a] = s.href
                }
            }
        }
}

function main(e) {
    initializeMappings();
    e = getParameterMap(e);
    e && updateLinks(createValueMap(e, getTrafficSourceValues()))
}